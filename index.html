<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Helldivers 2 — Weapon & Enemy Data</title>
  <style>
    :root {
      /* Helldivers-wiki-ish palette */
      --bg: #0e0e0e;              /* page background */
      --panel: #1b1b1b;           /* card/panel bg ~ #222 */
      --muted: #bdbdbd;           /* muted text */
      --text: #ffffff;            /* main text */
      --accent: #f8f833;          /* yellow accent (pi-secondary-background ~ 248,248,51) */
      --accent-2: #ff4b41;        /* breadcrumb hover orange/red */
      --border: #333333;          /* hard borders */
      --shadow: 0 0 0 rgba(0,0,0,0); /* go flat/industrial */
      --orange: #ff9a3c;
      --yellow: #ffd857;
      --cyan: #66e0ff;
      --red: #ff5a5a;
      --blue: #6aa1ff;
      --green: #6aff88;
      --ap-yellow: #ffd857;
      --ap-orange: #ff9a3c;
      --ap-red: #ff5a5a;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
    }
    header {
      position: sticky; top: 0; z-index: 50;
      background: #141414; /* solid, more angular look */
      border-bottom: 2px solid var(--border);
      padding: 10px 16px;
      display: flex; align-items: center; gap: 12px;
    }
    .logo { font-weight: 800; letter-spacing: 0.3px; }

    .tabs { display: flex; gap: 6px; margin-left: auto; }
    .tab { appearance: none; border: 2px solid var(--border); background: #171717; color: var(--muted); padding: 6px 10px; border-radius: 0; cursor: pointer; font-weight: 700; }
    .tab.active { background: #1f1f1f; color: var(--text); border-color: var(--accent); box-shadow: var(--shadow); }

    /* Wider content to accommodate long Atk Names */
    main { max-width: 1600px; margin: 16px auto; padding: 0 16px 24px; }
    .panel { position: relative; background: var(--panel); border: 2px solid var(--border); border-radius: 0; box-shadow: var(--shadow); }

    /* Filters / Controls */
    .filters { padding: 10px 12px; border-bottom: 2px solid var(--border); display: grid; gap: 8px; }
    .row { display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
    .label { font-size:12px; color: var(--muted); font-weight: 800; text-transform: uppercase; }

    .input, .button, .select { background: #141414; border: 2px solid var(--border); color: var(--text); padding: 8px 10px; border-radius: 0; }
    .button { cursor: pointer; font-weight: 800; }
    .button:hover { border-color: var(--accent); }
    #search { min-width: 420px; }

    /* Top-right data selector */
    .data-controls { position:absolute; top:8px; right:10px; display:flex; gap:6px; align-items:center; }
    .hidden { display: none !important; }

    /* Table */
    .table-wrap { overflow: auto; max-height: 70vh; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; table-layout: auto; }
    thead th { position: sticky; top: 0; background: #202020; z-index: 2; text-align: left; font-size: 12px; letter-spacing: 0.3px; color: var(--muted); border-bottom: 2px solid var(--border); padding: 10px 12px; user-select: none; cursor: pointer; white-space: nowrap; }
    thead th:hover { background: #242424; color: var(--accent); }
    tbody td { padding: 10px 12px; border-bottom: 1px solid var(--border); }
    tbody tr.group-start td { border-top: 2px solid #3a3a3a; }
    tbody tr:hover { background: rgba(255,255,255,0.03); }
    .sort-indicator { opacity: 0.8; margin-left: 6px; font-size: 11px; color: var(--accent); }

    .name-link { color: var(--accent); text-decoration: underline; text-underline-offset: 2px; }
    .name-link:hover { color: var(--accent-2); }

    /* Quick chips */
    .chiprow { display:flex; gap:6px; flex-wrap: wrap; align-items:center; }
    .chip { cursor:pointer; border:2px solid var(--border); background:#171717; color:var(--muted); padding:6px 10px; border-radius:0; font-weight:800; font-size:12px; user-select:none; }
    .chip.active { background:#202020; color: var(--text); border-color: var(--accent); }

    /* Number color helpers for attack types */
    .num-orange { color: var(--orange); }
    .num-yellow { color: var(--yellow); }
    .num-cyan   { color: var(--cyan); }
    .num-red    { color: var(--red); }

    /* AP color helpers */
    .ap-white  { color: var(--text); }
    .ap-blue   { color: #58a6ff; }
    .ap-green  { color: #4caf50; }
    .ap-yellow { color: #f8f833; }
    .ap-orange { color: #ff9a3c; }
    .ap-red    { color: #ff4b41; }
  </style>
</head>
<body>
  <header>
    <div class="logo">Super Calculator</div>
    <nav class="tabs">
      <button class="tab active" data-tab="weapons">Weapon Data</button>
      <button class="tab" data-tab="enemies">Enemy Data</button>
      <button class="tab" data-tab="calculator">Damage Calculator</button>
    </nav>
  </header>

  <main>
    <!-- WEAPON DATA TAB -->
    <section id="tab-weapons" class="panel">
      <!-- top-right data selector -->
      <div id="dataControls" class="data-controls">
        <select id="dataMode" class="select">
          <option value="onlineCsv" selected>Online (CSV)</option>
          <option value="file">Upload CSV/TSV</option>
        </select>
        <button class="button" id="reloadOnline">Reload</button>
        <button class="button" id="chooseFile">Choose File</button>
        <input type="file" id="fileInput" accept=".csv,.tsv,text/csv,text/tab-separated-values" class="hidden" />
        <span id="statusMsg" style="font-size:12px;color:var(--muted)"></span>
      </div>

      <!-- left-aligned filters -->
      <div class="filters">
        <div class="row">
          <span class="label">Type:</span>
          <div class="chiprow" id="typeFilters" title="Quick filter by weapon type"></div>
        </div>
        <div class="row">
          <span class="label">Sub:</span>
          <div class="chiprow" id="subFilters" title="Quick filter by subtype"></div>
        </div>
        <div class="row">
          <input class="input" id="search" placeholder="Quick filter… (matches any column)" />
          <button class="button" id="resetSort">Reset sort</button>
          <span id="testBadge" style="font-size:12px;color:var(--muted)"></span>
        </div>
      </div>

      <div class="table-wrap">
        <table id="weaponsTable">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- ENEMY DATA TAB (placeholder) -->
    <section id="tab-enemies" class="panel hidden">
      <div class="filters"><div class="row"><span class="label">Enemy Data</span></div></div>
      <div style="padding:16px;color:var(--muted)">Coming soon.</div>
    </section>

    <!-- CALCULATOR TAB (placeholder) -->
    <section id="tab-calculator" class="panel hidden">
      <div class="filters"><div class="row"><span class="label">Damage Calculator</span></div></div>
      <div style="padding:16px;color:var(--muted)">Coming soon.</div>
    </section>
  </main>

  <script>
    // ====== CONFIG (Published CSV only) ======
    const PUBLISHED_CSV_URL  = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTeLqZ5-maEmzrM6SUDMRXpHEhV0tQImiBdgMCil9lSA11IiY_nGdamE54W7DAiSXn1XuJljdF4P537/pub?gid=0&single=true&output=csv';
    const TEST_MODE = new URLSearchParams(location.search).has('test');

    // ====== STATE ======
    let headers = [];
    let rows = [];
    let groups = [];
    let filteredGroups = [];
    let filterActive = false;
    let sortKey = null;
    let sortDir = 'asc';
    let typeKeyGlobal = null;
    let subKeyGlobal  = null;
    let nameKeyGlobal = null;
    let codeKeyGlobal = null;
    let atkTypeKeyGlobal = null; 
    let dmgKey = null, durKey = null, apKey = null;

    // ====== UTILS ======
    const isNumber = (v) => v !== null && v !== '' && !isNaN(Number(v));
    const setStatus = (msg, isError=false) => {
      const el = document.getElementById('statusMsg');
      if (!el) return;
      el.textContent = msg || '';
      el.style.color = isError ? '#ff8080' : 'var(--muted)';
    };
    const hideDataControls = () => document.getElementById('dataControls').classList.add('hidden');
    const showDataControls = () => document.getElementById('dataControls').classList.remove('hidden');

    function guessNumericColumn(key) {
      let cnt = 0, ok = 0;
      for (const g of groups) {
        for (const r of g.rows) {
          cnt++; if (isNumber(r[key])) ok++; if (cnt >= 40) break;
        }
        if (cnt >= 40) break;
      }
      return ok >= Math.max(3, Math.floor(cnt * 0.6));
    }

    function groupSortValue(group, key, numeric) {
      if (key === nameKeyGlobal) return (group.name || '').toString();
      if (numeric) {
        const vals = group.rows.map(r => Number(r[key])).filter(n => !isNaN(n));
        return vals.length ? Math.max(...vals) : Number.NEGATIVE_INFINITY;
      } else {
        for (const r of group.rows) { const v = r[key]; if (v !== null && v !== undefined && v !== '') return String(v); }
        return '';
      }
    }

    function classifyAtkType(row) {
      const raw = (atkTypeKeyGlobal && row[atkTypeKeyGlobal]) ? String(row[atkTypeKeyGlobal]) : (row['Stage'] ? String(row['Stage']) : '');
      const v = raw.toLowerCase();
      if (v.includes('explosion') || v === 'explosion') return 'explosion';
      if (v.includes('beam') || v === 'beam') return 'beam';
      if (v.includes('arc') || v === 'arc') return 'arc';
      if (v.includes('spray') || v === 'spray') return 'spray';
      return '';
    }

    function apColorClass(val) {
      if (val === null || val === undefined || val === '') return 'ap-white';
      const s = String(val).toLowerCase();
      const nums = (s.match(/\d+/g) || []).map(n => parseInt(n,10));
      const n = nums.length ? Math.max(...nums) : (isNumber(s) ? Number(s) : NaN);
      if (isNaN(n) || n <= 0) return 'ap-white';
      if (n === 1 || n === 2) return 'ap-blue';
      if (n === 3) return 'ap-green';
      if (n === 4) return 'ap-yellow';
      if (n === 5) return 'ap-orange';
      if (n >= 6) return 'ap-red';
      return 'ap-white';
    }

    // ====== CSV PARSER ======
    function parseDelimited(text, delimiter=',') {
      const rows = []; let cur = [], cell = ''; let inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        if (inQuotes) { if (ch === '"') { if (text[i+1] === '"') { cell += '"'; i++; } else { inQuotes = false; } } else { cell += ch; } }
        else { if (ch === '"') { inQuotes = true; } else if (ch === delimiter) { cur.push(cell); cell = ''; } else if (ch === '\n') { cur.push(cell); rows.push(cur); cur = []; cell=''; } else if (ch === '\r') { /* ignore */ } else { cell += ch; } }
      }
      cur.push(cell); rows.push(cur); return rows;
    }

    // ====== INGESTION HELPERS ======
    function ingestHeadersAndRows(newHeaders, newRows) {
      headers = newHeaders; rows = newRows;

      const lower = (s) => String(s||'').toLowerCase();
      typeKeyGlobal = headers.find(h => lower(h) === 'type') || headers.find(h => lower(h).includes('weapon') && lower(h).includes('type')) || null;
      subKeyGlobal  = headers.find(h => ['sub','subtype'].includes(lower(h)) || lower(h).includes('sub ')) || null;
      codeKeyGlobal = headers.find(h => lower(h) === 'code') || null;
      nameKeyGlobal = headers.find(h => lower(h) === 'atkname') || headers.find(h => lower(h) === 'name') || headers[0];
      atkTypeKeyGlobal = headers.find(h => ['atktype','atk type'].includes(lower(h)) || lower(h).includes('attack type')) || (headers.includes('Stage') ? 'Stage' : null);
      dmgKey = headers.find(h => ['damage','dmg'].includes(lower(h))) || null;
      durKey = headers.find(h => ['dur','duration'].includes(lower(h))) || null;
      apKey  = headers.find(h => lower(h) === 'ap' || (lower(h).includes('armor') && lower(h).includes('pen'))) || null;

      const map = new Map(); let index = 0;
      for (const row of rows) {
        const name = (row[nameKeyGlobal] ?? '').toString();
        if (!map.has(name)) { map.set(name, { name, rows: [], index: index++, type: null, sub: null }); }
        map.get(name).rows.push(row);
      }

      for (const g of map.values()) {
        if (typeKeyGlobal) { for (const r of g.rows) { const v = r[typeKeyGlobal]; if (v !== null && v !== undefined && String(v).trim() !== '') { g.type = String(v).trim(); break; } } }
        if (subKeyGlobal)  { for (const r of g.rows) { const v = r[subKeyGlobal]; if (v !== null && v !== undefined && String(v).trim() !== '') { g.sub = String(v).trim(); break; } } }
      }

      groups = Array.from(map.values());
      buildTypeFilters();
      buildSubFilters();
      renderTable();

      setStatus('', false);
      if (TEST_MODE) runTests();
    }

    function ingestMatrix(matrix) {
      if (!matrix.length) throw new Error('Empty data');
      const hdrs = matrix[0].map(h => String(h||'').trim() || '');
      const bodyRows = matrix.slice(1)
        .filter(r => r.some(c => String(c).trim() !== ''))
        .map(r => { const obj = {}; hdrs.forEach((h,i)=> obj[h] = r[i] !== undefined ? r[i] : null); return obj; });
      ingestHeadersAndRows(hdrs, bodyRows);
    }

    function loadFromText(text) {
      const firstLine = text.split(/\r?\n/)[0] || '';
      const delimiter = (firstLine.split('\t').length - 1) > (firstLine.split(',').length - 1) ? '\t' : ',';
      const matrix = parseDelimited(text, delimiter === '\t' ? '\t' : ',');
      ingestMatrix(matrix);
      hideDataControls(); // hide after successful file upload
    }

    // ====== RENDERING ======
    function renderTable() {
      const thead = document.getElementById('thead');
      const tbody = document.getElementById('tbody');

      thead.innerHTML = '';
      const trh = document.createElement('tr');
      headers.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h; th.title = `Sort by ${h}`;
        if (sortKey === h) { const span = document.createElement('span'); span.className = 'sort-indicator'; span.textContent = sortDir === 'asc' ? '▲' : '▼'; th.appendChild(span); }
        th.addEventListener('click', () => { if (sortKey === h) { sortDir = sortDir === 'asc' ? 'desc' : 'asc'; } else { sortKey = h; sortDir = 'asc'; } sortAndRenderBody(); });
        trh.appendChild(th);
      });
      thead.appendChild(trh);
      sortAndRenderBody();
    }

    function sortAndRenderBody() {
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      const source = filterActive ? filteredGroups : groups;

      let ordered = [...source];
      if (sortKey) {
        const numeric = guessNumericColumn(sortKey);
        ordered.sort((a, b) => {
          const va = groupSortValue(a, sortKey, numeric);
          const vb = groupSortValue(b, sortKey, numeric);
          if (numeric) return sortDir === 'asc' ? (va - vb) : (vb - va);
          return sortDir === 'asc' ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
        });
      }

      const wikiUrlForName = (name) => {
        if (!name) return null;
        const clean = String(name).replace(/\s*\(.*?\)\s*/g, ' ').trim().replace(/\s+/g,' ');
        return `https://helldivers.wiki.gg/wiki/Special:Search/${encodeURIComponent(clean)}`;
      };

      ordered.forEach((g) => {
        g.rows.forEach((r, idx) => {
          const tr = document.createElement('tr');
          if (idx === 0) tr.classList.add('group-start');
          const atkClass = classifyAtkType(r);
          headers.forEach(h => {
            const td = document.createElement('td');
            let v = r[h];
            if (idx > 0 && (h === nameKeyGlobal || h === typeKeyGlobal || h === codeKeyGlobal)) v = '';

            const hl = h.toLowerCase();
            const isDamage = /^(damage|dmg)$/.test(hl);
            const isDuration = /^(dur|duration)$/.test(hl);
            if ((isDamage || isDuration) && atkClass) {
              if (atkClass === 'explosion') td.classList.add('num-orange');
              else if (atkClass === 'beam') td.classList.add('num-yellow');
              else if (atkClass === 'arc') td.classList.add('num-cyan');
              else if (atkClass === 'spray') td.classList.add('num-red');
            }

            if (apKey && h === apKey) td.classList.add(apColorClass(v));
            else if (!apKey && (hl === 'ap' || (hl.includes('armor') && hl.includes('pen')))) td.classList.add(apColorClass(v));

            if (h === nameKeyGlobal && idx === 0 && v) { const a = document.createElement('a'); a.href = wikiUrlForName(v); a.target = '_blank'; a.rel = 'noreferrer noopener'; a.className = 'name-link'; a.textContent = String(v); td.appendChild(a); }
            else { if (isNumber(v)) { const n = Number(v); v = Number.isInteger(n) ? n.toString() : n.toFixed(3).replace(/\.0+$/, ''); } td.textContent = (v === null || v === undefined) ? '' : v; }

            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      });
    }

    // ====== DATA LOADING (CSV only) ======
    async function loadCSV() {
      setStatus('Loading online CSV…');
      const res = await fetch(PUBLISHED_CSV_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();
      const firstLine = text.split(/\r?\n/)[0] || '';
      const delimiter = (firstLine.split('\t').length - 1) > (firstLine.split(',').length - 1) ? '\t' : ',';
      const matrix = parseDelimited(text, delimiter === '\t' ? '\t' : ',');
      ingestMatrix(matrix);
      setStatus('Loaded online CSV.');
      hideDataControls(); // hide selector after successful URL load
    }

    // ====== FILTERING (Search + Type + Sub) ======
    let searchQuery = '';

    function applyFilters() {
      const typeContainer = document.getElementById('typeFilters');
      const subContainer  = document.getElementById('subFilters');
      const activeTypes = typeContainer ? Array.from(typeContainer.querySelectorAll('.chip.active')).map(b => b.dataset.val) : [];
      const activeSubs  = subContainer  ? Array.from(subContainer.querySelectorAll('.chip.active')).map(b => b.dataset.val)  : [];

      const typeFilterActive = !!(typeContainer && activeTypes.length);
      const subFilterActive  = !!(subContainer  && activeSubs.length);
      const hasSearch = searchQuery.length > 0;

      if (!typeFilterActive && !subFilterActive && !hasSearch) {
        filterActive = false; filteredGroups = []; sortAndRenderBody(); return;
      }

      filteredGroups = groups.filter(g => {
        if (typeFilterActive) { const t = (g.type || '').toString().toLowerCase(); if (!activeTypes.includes(t)) return false; }
        if (subFilterActive)  { const s = (g.sub || '').toString().toLowerCase(); if (!activeSubs.includes(s)) return false; }
        if (!hasSearch) return true;
        const q = searchQuery;
        if ((g.name || '').toLowerCase().includes(q)) return true;
        for (const r of g.rows) { for (const h of headers) { const v = r[h]; if (v !== null && v !== undefined && String(v).toLowerCase().includes(q)) return true; } }
        return false;
      });

      filterActive = true; sortAndRenderBody();
    }

    function buildTypeFilters() {
      const el = document.getElementById('typeFilters'); if (!el) return;
      const present = new Set();
      for (const g of groups) { const t = (g.type || '').toString().trim(); if (t) present.add(t.toLowerCase()); }
      const orderedDesired = ['primary','secondary','grenade','support','stratagem'];
      const defaults = new Set(['primary']);
      el.innerHTML = '';
      orderedDesired.forEach(t => {
        if (!present.has(t)) return;
        const chip = document.createElement('button'); chip.type = 'button';
        chip.className = 'chip' + (defaults.has(t) ? ' active' : '');
        chip.textContent = t.charAt(0).toUpperCase() + t.slice(1);
        chip.dataset.val = t;
        chip.addEventListener('click', () => { chip.classList.toggle('active'); applyFilters(); });
        el.appendChild(chip);
      });
      applyFilters();
    }

    function buildSubFilters() {
      const el = document.getElementById('subFilters'); if (!el) return;
      const subs = new Set();
      for (const g of groups) { const s = (g.sub || '').toString().trim(); if (s) subs.add(s.toLowerCase()); }
      const ordered = Array.from(subs).sort((a,b)=>a.localeCompare(b));
      el.innerHTML = '';
      ordered.forEach(s => {
        const chip = document.createElement('button'); chip.type = 'button';
        chip.className = 'chip'; // start INACTIVE by default
        chip.textContent = s.toUpperCase();
        chip.dataset.val = s;
        chip.addEventListener('click', () => { chip.classList.toggle('active'); applyFilters(); });
        el.appendChild(chip);
      });
      applyFilters();
    }

    document.getElementById('search').addEventListener('input', (e) => { searchQuery = e.target.value.trim().toLowerCase(); applyFilters(); });
    document.getElementById('resetSort').addEventListener('click', () => { sortKey = null; sortDir = 'asc'; sortAndRenderBody(); });

    // ====== Data source controls ======
    const dataModeSel = document.getElementById('dataMode');
    const chooseFileBtn = document.getElementById('chooseFile');
    const fileInput = document.getElementById('fileInput');
    const reloadOnlineBtn = document.getElementById('reloadOnline');

    dataModeSel.addEventListener('change', () => {
      const mode = dataModeSel.value;
      // Only show our styled "Choose File" button. Keep the native input hidden at all times.
      chooseFileBtn.classList.toggle('hidden', mode !== 'file');
    });

    reloadOnlineBtn.addEventListener('click', async () => {
      try { await loadCSV(); }
      catch (err) { console.error(err); setStatus('Online load failed. Try Upload.', true); showDataControls(); dataModeSel.value = 'file'; chooseFileBtn.classList.remove('hidden');  }
    });

    chooseFileBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => {
      const file = fileInput.files && fileInput.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = () => { try { loadFromText(String(reader.result||'')); } catch (err) { console.error(err); setStatus('Failed to parse uploaded file.', true); showDataControls(); } };
      reader.readAsText(file);
    });

    // ====== TABS ======
    const sections = { weapons: document.getElementById('tab-weapons'), enemies: document.getElementById('tab-enemies'), calculator: document.getElementById('tab-calculator') };
    document.querySelectorAll('.tab').forEach(btn => { btn.addEventListener('click', () => { document.querySelectorAll('.tab').forEach(b => b.classList.remove('active')); btn.classList.add('active'); const tab = btn.dataset.tab; for (const k in sections) { sections[k].classList.toggle('hidden', k !== tab); } }); });

    // ====== DEV TESTS ======
    function runTests() {
      const badge = document.getElementById('testBadge'); if (badge) badge.textContent = '• Test mode active';
      console.group('%cDEV TESTS','color:#8cf');
      try {
        // Test 1: Type chips order and defaults
        const typeLbls = Array.from(document.querySelectorAll('#typeFilters .chip')).map(c=>c.dataset.val);
        const expectedOrder = ['primary','secondary','grenade','support','stratagem'].filter(t=>typeLbls.includes(t));
        console.assert(JSON.stringify(typeLbls) === JSON.stringify(expectedOrder), 'Type chips should appear in required order');
        const defaultActive = new Set(['primary']);
        const defaultsOk = Array.from(document.querySelectorAll('#typeFilters .chip')).every(c => defaultActive.has(c.dataset.val) ? c.classList.contains('active') : !c.classList.contains('active'));
        console.assert(defaultsOk, 'Default active set should be primary only');

        // Test 2: Sub chips exist, are uppercase and active by default
        const subEls = Array.from(document.querySelectorAll('#subFilters .chip'));
        console.assert(subEls.length >= 0, 'Subtype chips render');
        const noneActive = subEls.every(c=>!c.classList.contains('active'));
        console.assert(noneActive, 'Subtype chips should start inactive');
        const allUpper = subEls.every(c=>c.textContent === c.textContent.toUpperCase());
        console.assert(allUpper, 'Subtype chip labels should be UPPERCASE');

        // Test 3: DataMode has no Paste option
        const options = Array.from(document.querySelectorAll('#dataMode option')).map(o=>o.value);
        console.assert(!options.includes('paste') && options.includes('onlineCsv') && options.includes('file'), 'DataMode should only include onlineCsv and file');

        // Test 4: File input stays hidden; only Choose File is visible in file mode
        dataModeSel.value = 'file';
        dataModeSel.dispatchEvent(new Event('change'));
        console.assert(!chooseFileBtn.classList.contains('hidden'), 'Choose File should be visible in file mode');
        console.assert(document.getElementById('fileInput').classList.contains('hidden'), 'Native file input should remain hidden');

        // Test 5: Data controls hide after load
        showDataControls();
        hideDataControls();
        console.assert(document.getElementById('dataControls').classList.contains('hidden'), 'Data controls should be hideable');

        console.log('%cAll tests passed','color:#4caf50');
      } catch (e) { console.error('Test run error:', e); } finally { console.groupEnd(); }
    }

    function loadMockData(){
      headers = ['Code','AtkName','Type','Sub','AP','Damage','Dur','AtkType'];
      rows = [
        { Code:'ARC-01', AtkName:'Arc Blaster',        Type:'Primary',   Sub:'Energy',     AP:'0',   Damage:30,  Dur:0.5, AtkType:'Arc' },
        { Code:'ARC-01', AtkName:'Arc Blaster (Mk2)',  Type:'Primary',   Sub:'Energy',     AP:'0',   Damage:60,  Dur:0.3, AtkType:'Explosion' },
        { Code:'GNP-02', AtkName:'Grenade Pistol',     Type:'Secondary', Sub:'Sidearm',    AP:'3',   Damage:90,  Dur:0.0, AtkType:'Projectile' },
        { Code:'GNP-02', AtkName:'Grenade Pistol',     Type:'Secondary', Sub:'Sidearm',    AP:'3',   Damage:120, Dur:0.0, AtkType:'Explosion' },
        { Code:'GL6-FR', AtkName:'GL-6 Frag',          Type:'Grenade',   Sub:'Explosive',  AP:'4',   Damage:220, Dur:0.0, AtkType:'Explosion' },
        { Code:'OBL-77', AtkName:'Orbital Laser',      Type:'Support',   Sub:'Orbital',    AP:'6+',  Damage:300, Dur:2.0, AtkType:'Beam' },
        { Code:'SPR-09', AtkName:'Spear',              Type:'Stratagem', Sub:'Anti-Armor', AP:'5',   Damage:200, Dur:0.0, AtkType:'Impact' },
        { Code:'FLM-10', AtkName:'Flamethrower',       Type:'Primary',   Sub:'Spray',      AP:'1/2', Damage:25,  Dur:1.8, AtkType:'Spray' }
      ];
      ingestHeadersAndRows(headers, rows);
    }

    // Boot
    (function boot(){
      if (TEST_MODE) { document.getElementById('testBadge').textContent = '• Test mode active (using mock data)'; loadMockData(); }
      else { loadCSV().catch(err => { console.error('CSV load failed:', err); setStatus('Online load failed. Use Upload.', true); showDataControls(); document.getElementById('dataMode').value = 'file'; document.getElementById('chooseFile').classList.remove('hidden');  }); }
    })();
  </script>
</body>
</html>
